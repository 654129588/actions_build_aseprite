# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build-win:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - name: Setup Ninja
      uses: ashutoshvarma/setup-ninja@v1
      with:
        version: 1.10.0
        dest: ninja_bin
        platform: win
    - name: env
      id: late
      run: curl -s https://api.github.com/repos/aseprite/aseprite/releases | jq '.[0] | .assets[0] | .browser_download_url' | tr -d '"'
    - name: Clone aseprite source
      run: |
        echo  ${{ steps.late.outputs.action_late }}
        iwr -outf aseprite.zip ${{ steps.late.outputs.action_late }}
        7z x aseprite.zip -y -oaseprite
        cd aseprite
        mkdir build
    - name: Download compiled skia
      run: |
        iwr -outf skia.zip https://github.com/aseprite/skia/releases/download/m81-b607b32047/Skia-Windows-Release-x64.zip
        7z x skia.zip -y -oskia
    - name: Enable Developer Command Prompt
      uses: ilammy/msvc-dev-cmd@v1.2.0
      with:
        arch: x64
        sdk: 10.0.18362.0
    - name: Compiling aseprite for Windows
      run: |
        cd aseprite
        cd build
        cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -DLAF_BACKEND=skia -DSKIA_DIR=D:\a\action_aseprite\action_aseprite\skia -DSKIA_LIBRARY_DIR=D:\a\action_aseprite\action_aseprite\skia\out\Release-x64 -DCMAKE_IGNORE_PATH="C:/ProgramData/chocolatey/bin/;C:/Strawberry/c/bin/" -G Ninja ..
        ninja aseprite
    - name: Archive bin
      run: |
        cd aseprite\build\bin
        7z -tzip a aseprite-win.zip * -mx0
        cd ..\..\..
        mv aseprite\build\bin\aseprite-win.zip .
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v2
      with:
        path: aseprite-win.zip
